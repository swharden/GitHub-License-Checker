<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GitHub License Checker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        a {
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="content mx-auto my-5" id="main" style="max-width: 800px;">
        <h1>GitHub License Checker</h1>
        <div class="fs-5">Check the license for all your GitHub repositories</div>

        <div class="input-group mt-5 w-50">
            <span class="input-group-text" id="basic-addon3">GitHub User</span>
            <input type="text" class="form-control" id="ghu" value="swharden">
            <button class="btn btn-primary">Search</button>
        </div>

        <div class="d-flex d-flex align-items-center mt-2">
            <div class="mx-2" id="statusMessage"></div>
            <div class="spinner-border text-primary spinner-border-sm invisible" role="status" id="statusSpinner">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <div class="alert alert-danger collapse" role="alert" id="errorMessage"></div>


        <table class="table w-auto mt-5" id="repos-table">
            <thead>
                <tr>
                    <th scope="col">Repository</th>
                    <th scope="col">License</th>
                </tr>
            </thead>
            <tbody id="repos-table-body">
            </tbody>
        </table>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script>

        function setStatus(message, showSpinner) {
            const messageDiv = document.getElementById('statusMessage');
            messageDiv.innerText = message;

            const spinnerDiv = document.getElementById('statusSpinner');
            if (showSpinner) {
                spinnerDiv.classList.remove("invisible");
            } else {
                spinnerDiv.classList.add("invisible");
            }
        }

        function clearTable() {

        }

        function showError(message) {
            const div = document.getElementById('errorMessage');
            if (!message) {
                div.classList.add("collapse");
                return;
            }
            console.log(message);
            div.innerText = message;
            div.classList.remove("collapse");
            setStatus("", false);
        }

        function addPage(username, page, maxPageCount = 5) {
            const url = `https://api.github.com/users/${username}/repos?per_page=100&page=${page}`;
            setStatus(`Loading page ${page}...`, true);
            console.log(`fetching ${url}`);
            fetch(url)
                .then(response => {
                    return response.ok
                        ? response.json()
                        : response.json().then(json => { throw new Error(`${response.status} ${json.message}`); });
                })
                .then(repos => {
                    if (repos.len == 0 || page > maxPageCount) {
                        setStatus(`Loaded ${tableBody.rows.length} repositories (${page} API requests)`);
                        return;
                    }
                    const tableBody = document.getElementById("repos-table-body");
                    repos
                        .filter(x => !x.fork)
                        .forEach(repo => {
                            console.log(repo);
                            const tr = document.createElement('tr');
                            tr.innerHTML = `<td><a href='${repo.html_url}' target='_blank'>${repo.name}</a></td><td>${repo.license.key}</td>`;
                            tableBody.appendChild(tr);
                        });
                    addPage(username, page + 1);
                })
                .catch(error => {
                    showError(error);
                });
        }

        function update() {
            const username = "swharden";
            clearTable();
            addPage(username, 1);
        }

        update();
    </script>
</body>

</html>